{{- range .Values.servers }}

{{- if .autoscaler.enabled }}

{{- $scaleUp := .autoscaler.scaleUp }}
{{- $scaleDown := .autoscaler.scaleDown }}
{{- $prometheusAddress := printf "http://%s:%d" .prometheus.url (int .prometheus.port) | quote }}

apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ .envoy.name }}-tritonserver-scaledobject
spec:
  scaleTargetRef:
    name: {{ .triton.name }}
    kind: Deployment
  pollingInterval: 30
  cooldownPeriod: 120
  idleReplicaCount: 0
  minReplicaCount: {{ .autoscaler.minReplicas }}
  maxReplicaCount: {{ .autoscaler.maxReplicas }}
  advanced:
    horizontalPodAutoscalerConfig:
      behavior:
        scaleDown:
          stabilizationWindowSeconds: {{ $scaleDown.window }}
          policies:
            - periodSeconds: {{ $scaleDown.period }}
              type: Pods
              value: {{ $scaleDown.stepsize }}
        scaleUp:
          stabilizationWindowSeconds: {{ $scaleUp.window }}
          policies:
            - periodSeconds: {{ $scaleUp.period }}
              type: Pods
              value: {{ $scaleUp.stepsize }}

  triggers:
  - type: prometheus
    metricType: Value
    metadata:
      serverAddress: {{ $prometheusAddress }}
      metricName: autoscaler-metric
      threshold: {{ .prometheus.serverAvailabilityThreshold | quote }}
      query: {{ .prometheus.serverAvailabilityMetric | quote }}

---


{{- end }}

{{- end }}