apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "supersonic.grafanaName" . }}-dashboard
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ include "supersonic.name" . }}
    app.kubernetes.io/component: grafana
data:
  default.json: |-
    {{- $dashboard := $.Files.Get "dashboards/default.json" }}
    {{- $variables := $.Files.Get "dashboards/variables.json" }}
    {{- $dashboard := $dashboard | fromJson }}
    {{- $variables := $variables | fromJson }}
    {{- $dashboard := merge $dashboard $variables }}
    {{- $dashboard := $dashboard | toJson }}
    {{- $dashboard := $dashboard | replace "%RELEASE_NAME%" .Release.Name }}
    {{- $dashboard := $dashboard | replace "%CHART_VERSION%" .Chart.Version }}
    {{- $metric := include "supersonic.defaultMetric" . | replace "\n" "" | trim | replace "\"" "\\\"" }}
    {{- $dashboard := $dashboard | replace "%SERVER_LOAD_METRIC%" $metric }}
    {{- $threshold := .Values.prometheus.serverLoadThreshold | toString }}
    {{- $dashboard := $dashboard | replace "%SERVER_LOAD_THRESHOLD%" $threshold }}
    {{- $header := $.Files.Get "dashboards/header.html" | replace "\n" "" | replace "\"" "\\\"" }}
    {{- $dashboard := $dashboard | replace "%HEADER%" $header }}
    {{ $dashboard | nindent 4 }}
  triton.json: |-
    {{- $.Files.Get "dashboards/triton.json" | nindent 4 }}
