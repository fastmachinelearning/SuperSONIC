apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "supersonic.grafanaName" . }}-dashboard
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ include "supersonic.name" . }}
    app.kubernetes.io/component: grafana
data:
  default.json: |-
    {{- $dashboard := $.Files.Get "dashboards/default.json" | nindent 4 }}
    {{- $dashboard := $dashboard | replace "%RELEASE_NAME%" .Release.Name }}
    {{- $dashboard := $dashboard | replace "%CHART_VERSION%" .Chart.Version }}
    {{- $metric := include "supersonic.defaultMetric" . | replace "\n" "" | trim | replace "\"" "\\\"" }}
    {{- $dashboard := $dashboard | replace "%SERVER_LOAD_METRIC%" $metric }}
    {{- $threshold := .Values.prometheus.serverLoadThreshold | toString }}
    {{- $dashboard := $dashboard | replace "%SERVER_LOAD_THRESHOLD%" $threshold }}
    {{- $dashboard | indent 4 }}
  triton.json: {{ $.Files.Get "dashboards/triton.json" | nindent 4 }}
